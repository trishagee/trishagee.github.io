<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Trisha Gee  | Dissecting the Disruptor: Why it&#39;s so fast (part two) - Magic cache line padding</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.49" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.e08a958ae3e530145318b6373195c765.css" rel="stylesheet">
    

    

    
      
<link rel="shortcut icon" href="/favicon.png" type="image/x-icon" />

    

    

    <meta property="og:title" content="Dissecting the Disruptor: Why it&#39;s so fast (part two) - Magic cache line padding" />
<meta property="og:description" content="We mention the phrase Mechanical Sympathy quite a lot, in fact it&rsquo;s even Martin&rsquo;s blog title. &nbsp;It&rsquo;s about understanding how the underlying hardware operates and programming in a way that works with that, not against it.
We get a number of comments and questions about the mysterious cache line padding in the RingBuffer, and I referred to it in the last post. &nbsp;Since this lends itself to pretty pictures, it&rsquo;s the next thing I thought I would tackle." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://trishagee.github.io/post/dissecting_the_disruptor_why_its_so_fast_part_two__magic_cache_line_padding/" /><meta property="article:published_time" content="2011-07-22T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2011-07-22T00:00:00&#43;00:00"/>

<meta itemprop="name" content="Dissecting the Disruptor: Why it&#39;s so fast (part two) - Magic cache line padding">
<meta itemprop="description" content="We mention the phrase Mechanical Sympathy quite a lot, in fact it&rsquo;s even Martin&rsquo;s blog title. &nbsp;It&rsquo;s about understanding how the underlying hardware operates and programming in a way that works with that, not against it.
We get a number of comments and questions about the mysterious cache line padding in the RingBuffer, and I referred to it in the last post. &nbsp;Since this lends itself to pretty pictures, it&rsquo;s the next thing I thought I would tackle.">


<meta itemprop="datePublished" content="2011-07-22T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2011-07-22T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1234">



<meta itemprop="keywords" content="java,disruptor,lmax,mechanical sympathy,disruptor-docs,concurrency," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Dissecting the Disruptor: Why it&#39;s so fast (part two) - Magic cache line padding"/>
<meta name="twitter:description" content="We mention the phrase Mechanical Sympathy quite a lot, in fact it&rsquo;s even Martin&rsquo;s blog title. &nbsp;It&rsquo;s about understanding how the underlying hardware operates and programming in a way that works with that, not against it.
We get a number of comments and questions about the mysterious cache line padding in the RingBuffer, and I referred to it in the last post. &nbsp;Since this lends itself to pretty pictures, it&rsquo;s the next thing I thought I would tackle."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <div></div>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3">
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://trishagee.github.io" title="Home page">
              Home
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/post/" title="Posts page">
              Posts
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/presentation/" title="Presentations page">
              Presentations
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/resources/" title="Resources page">
              Resources
            </a>
          </li>
          
        </ul>
      
      



  <a href="https://twitter.com/trisha_gee" class="link-transition twitter link dib z-999 pt3 pt0-l mr2" title="Twitter link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>



  <a href="https://www.youtube.com/user/pmgee/" class="link-transition youtube link dib z-999 pt3 pt0-l mr2" title="Youtube link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.527,41.34c-0.278,0-0.478,0.078-0.6,0.244  c-0.121,0.156-0.18,0.424-0.18,0.796v0.896h1.543V42.38c0-0.372-0.062-0.64-0.185-0.796C42.989,41.418,42.792,41.34,42.527,41.34z   M36.509,41.309c0.234,0,0.417,0.076,0.544,0.23c0.123,0.155,0.185,0.383,0.185,0.682v4.584c0,0.286-0.053,0.487-0.153,0.611  c-0.1,0.127-0.256,0.189-0.47,0.189c-0.148,0-0.287-0.033-0.421-0.096c-0.135-0.062-0.274-0.171-0.415-0.313v-5.531  c0.119-0.122,0.239-0.213,0.36-0.271C36.26,41.335,36.383,41.309,36.509,41.309z M41.748,44.658v1.672  c0,0.468,0.057,0.792,0.17,0.974c0.118,0.181,0.313,0.269,0.592,0.269c0.289,0,0.491-0.076,0.606-0.229  c0.114-0.153,0.175-0.489,0.175-1.013v-0.405h1.795v0.456c0,0.911-0.217,1.596-0.657,2.059c-0.435,0.459-1.089,0.687-1.958,0.687  c-0.781,0-1.398-0.242-1.847-0.731c-0.448-0.486-0.676-1.157-0.676-2.014v-3.986c0-0.768,0.249-1.398,0.742-1.882  c0.493-0.484,1.128-0.727,1.911-0.727c0.799,0,1.413,0.225,1.843,0.674c0.429,0.448,0.642,1.093,0.642,1.935v2.264H41.748z   M38.623,48.495c-0.271,0.336-0.669,0.501-1.187,0.501c-0.343,0-0.646-0.062-0.912-0.192c-0.267-0.129-0.519-0.327-0.746-0.601  v0.681h-1.764V36.852h1.764v3.875c0.237-0.27,0.485-0.478,0.748-0.616c0.267-0.143,0.534-0.212,0.805-0.212  c0.554,0,0.975,0.189,1.265,0.565c0.294,0.379,0.438,0.933,0.438,1.66v4.926C39.034,47.678,38.897,48.159,38.623,48.495z   M30.958,48.884v-0.976c-0.325,0.361-0.658,0.636-1.009,0.822c-0.349,0.191-0.686,0.282-1.014,0.282  c-0.405,0-0.705-0.129-0.913-0.396c-0.201-0.266-0.305-0.658-0.305-1.189v-7.422h1.744v6.809c0,0.211,0.037,0.362,0.107,0.457  c0.077,0.095,0.196,0.141,0.358,0.141c0.128,0,0.292-0.062,0.488-0.188c0.197-0.125,0.375-0.283,0.542-0.475v-6.744h1.744v8.878  H30.958z M24.916,38.6v10.284h-1.968V38.6h-2.034v-1.748h6.036V38.6H24.916z M32.994,32.978c0-0.001,12.08,0.018,13.514,1.45  c1.439,1.435,1.455,8.514,1.455,8.555c0,0-0.012,7.117-1.455,8.556C45.074,52.969,32.994,53,32.994,53s-12.079-0.031-13.516-1.462  c-1.438-1.435-1.441-8.502-1.441-8.556c0-0.041,0.004-7.12,1.441-8.555C20.916,32.996,32.994,32.977,32.994,32.978z M42.52,29.255  h-1.966v-1.08c-0.358,0.397-0.736,0.703-1.13,0.909c-0.392,0.208-0.771,0.312-1.14,0.312c-0.458,0-0.797-0.146-1.027-0.437  c-0.229-0.291-0.345-0.727-0.345-1.311v-8.172h1.962v7.497c0,0.231,0.045,0.399,0.127,0.502c0.08,0.104,0.216,0.156,0.399,0.156  c0.143,0,0.327-0.069,0.548-0.206c0.22-0.137,0.423-0.312,0.605-0.527v-7.422h1.966V29.255z M31.847,27.588  c0.139,0.147,0.339,0.219,0.6,0.219c0.266,0,0.476-0.075,0.634-0.223c0.157-0.152,0.235-0.358,0.235-0.618v-5.327  c0-0.214-0.08-0.387-0.241-0.519c-0.16-0.131-0.37-0.196-0.628-0.196c-0.241,0-0.435,0.065-0.586,0.196  c-0.148,0.132-0.225,0.305-0.225,0.519v5.327C31.636,27.233,31.708,27.439,31.847,27.588z M30.408,19.903  c0.528-0.449,1.241-0.674,2.132-0.674c0.812,0,1.48,0.237,2.001,0.711c0.517,0.473,0.777,1.083,0.777,1.828v5.051  c0,0.836-0.255,1.491-0.762,1.968c-0.513,0.476-1.212,0.714-2.106,0.714c-0.858,0-1.547-0.246-2.064-0.736  c-0.513-0.492-0.772-1.152-0.772-1.983v-5.068C29.613,20.954,29.877,20.351,30.408,19.903z M24.262,16h-2.229l2.634,8.003v5.252  h2.213v-5.5L29.454,16h-2.25l-1.366,5.298h-0.139L24.262,16z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30  S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>


  <a href="https://www.linkedin.com/in/trishagee/" class="link-transition linkedin link dib z-999 pt3 pt0-l mr2" title="LinkedIn link">
    <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

  </a>


  <a href="https://github.com/trishagee/" class="link-transition github link dib z-999 pt3 pt0-l mr2" title="Github link">
    <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

  </a>



    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Dissecting the Disruptor: Why it&#39;s so fast (part two) - Magic cache line padding</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2011-07-22T00:00:00Z">July 22, 2011</time>
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>We mention the phrase Mechanical Sympathy quite a lot, in fact it&rsquo;s even <a href="http://mechanical-sympathy.blogspot.com/">Martin&rsquo;s blog title</a>. &nbsp;It&rsquo;s about understanding how the underlying hardware operates and programming in a way that works with that, not against it.<br /><br />We get a number of comments and questions about the mysterious cache line padding in the <a href="http://code.google.com/p/disruptor/source/browse/trunk/code/src/main/com/lmax/disruptor/RingBuffer.java">RingBuffer</a>, and I referred to it in the <a href="http://mechanitis.blogspot.com/2011/07/dissecting-disruptor-why-its-so-fast.html">last post</a>. &nbsp;Since this lends itself to pretty pictures, it&rsquo;s the next thing I thought I would tackle.<br /><br /><b>Comp Sci 101</b><br />One of the things I love about working at <a href="http://www.lmaxtrader.co.uk/">LMAX</a> is all that stuff I learnt at university and in my A Level Computing actually means something. &nbsp;So often as a developer you can get away with not understanding the CPU, data structures or <a href="http://en.wikipedia.org/wiki/Big_O_notation">Big O notation</a>&nbsp;- I spent 10 years of my career forgetting all that. &nbsp;But it turns out that if you do know about these things, and you apply that knowledge, you can come up with some very clever, very fast code.<br /><br />So, a refresher for those of us who studied this at school, and an intro for those who didn&rsquo;t. &nbsp;Beware - this post contains massive over-simplifications.<br /><br />The CPU is the heart of your machine and the thing that ultimately has to do all the operations, executing your program. &nbsp;Main memory (RAM) is where your data (including the lines of your program) lives. &nbsp;We&rsquo;re going to ignore stuff like hard drives and networks here because <a href="https://code.google.com/p/disruptor/">the Disruptor</a> is aimed at running as much as possible in memory.<br /><br />The CPU has several layers of cache between it and main memory, because even accessing main memory is too slow. &nbsp;If you&rsquo;re doing the same operation on a piece of data multiple times, it makes sense to load this into a place very close to the CPU when it&rsquo;s performing the operation (think a loop counter - you don&rsquo;t want to be going off to main memory to fetch this to increment it every time you loop around).<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-_rreUS6uUzs/TicrO8neu9I/AAAAAAAAIIs/1GVO_DbXcQo/s1600/CPUCache.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://1.bp.blogspot.com/-_rreUS6uUzs/TicrO8neu9I/AAAAAAAAIIs/1GVO_DbXcQo/s400/CPUCache.png" width="298" /></a></div><br />The closer the cache is to the CPU, the faster it is and the smaller it is. &nbsp;L1 cache is small and very fast, and right next to the core that uses it. &nbsp;L2 is bigger and slower, and still only used by a single core. &nbsp;L3 is more common with modern multi-core machines, and is bigger again, slower again, and shared across cores on a single socket. &nbsp;Finally you have main memory, which is shared across all cores and all sockets.<br /><br />When the CPU is performing an operation, it&rsquo;s first going to look in L1 for the data it needs, then L2, then L3, and finally if it&rsquo;s not in any of the caches the data needs to be fetched all the way from main memory. &nbsp;The further it has to go, the longer the operation will take. &nbsp;So if you&rsquo;re doing something very frequently, you want to make sure that data is in L1 cache.<br /><br />Martin and Mike&rsquo;s <a href="http://www.infoq.com/presentations/LMAX">QCon presentation</a> gives some indicative figures for the cost of cache misses:<br /><div style="text-align: left;"><br /></div><table style="text-align: left;"><tbody><tr><td><i>Latency from CPU to&hellip;</i></td><td style="padding-left: 5px; padding-right: 5px;"><i>Approx. number of<br />CPU cycles</i></td><td style="padding-left: 5px; padding-right: 5px;"><i>Approx. time <br />in nanoseconds</i></td> </tr><tr> <td>Main memory</td><td></td><td>~60-80ns</td></tr><tr> <td>QPI transit<br />(between sockets, not drawn)</td><td></td><td>~20ns</td></tr><tr> <td>L3 cache</td><td>~40-45 cycles, </td><td>~15ns</td></tr><tr> <td>L2 cache</td><td>~10 cycles, </td><td>~3ns</td></tr><tr> <td>L1 cache</td><td>~3-4 cycles,</td><td>~1ns</td></tr><tr> <td>Register</td><td>1 cycle</td><td></td></tr></tbody></table><div style="text-align: left;"><br /></div><div style="text-align: left;">If you&rsquo;re aiming for an end-to-end latency of something like 10 milliseconds, an 80 nanosecond trip to main memory to get some missing data is going to take a serious chunk of that.</div><div style="text-align: left;"><br /></div><div><b>Cache lines</b></div><div>Now the interesting thing to note is that it&rsquo;s not individual items that get stored in the cache - i.e. it&rsquo;s not a single variable, a single pointer. &nbsp;The cache is made up of cache lines, typically 64 bytes, and it effectively references a location in main memory. &nbsp;A Java <code>long</code> is 8 bytes, so in a single cache line you could have 8 <code>long</code> variables.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/--A4eyU2Joec/TicxZW-yQoI/AAAAAAAAIIw/E40PtQOzMfE/s1600/CacheLines.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="301" src="http://4.bp.blogspot.com/--A4eyU2Joec/TicxZW-yQoI/AAAAAAAAIIw/E40PtQOzMfE/s400/CacheLines.png" width="400" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">(I&rsquo;m going to ignore the multiple cache-levels for simplicity)</div><div style="text-align: left;"><br /></div><div style="text-align: left;">This is brilliant if you&rsquo;re accessing an array of longs - when one value from the array gets loaded into the cache, you get up to 7 more for free. &nbsp;So you can walk that array very quickly. &nbsp;In fact, you can iterate over any data structure that is allocated to contiguous blocks in memory very quickly. &nbsp;I made a passing reference to this in the very <a href="http://mechanitis.blogspot.com/2011/06/dissecting-disruptor-whats-so-special.html">first post about the ring buffer</a>, and it explains why we use an array for it.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">So if items in your data structure aren&rsquo;t sat next to each other in memory (linked lists, I&rsquo;m looking at you) you don&rsquo;t get the advantage of freebie cache loading. &nbsp;You could be getting a cache miss for every item in that data structure.</div><div style="text-align: left;"><br /></div><div>However, there is a drawback to all this free loading. &nbsp;Imagine your <code>long</code> isn&rsquo;t part of an array. &nbsp;Imagine it&rsquo;s just a single variable. &nbsp;Let&rsquo;s call it <code>head</code>, for no real reason. &nbsp;Then imagine you have another variable in your class right next to it. &nbsp;Let&rsquo;s arbitrarily call it <code>tail</code>. &nbsp;Now, when you load <code>head</code> into your cache, you get <code>tail</code> for free. </div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-4mwTYGoo99U/Tic141EFSgI/AAAAAAAAII0/Q2Y18D38iN0/s1600/FalseSharing.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://3.bp.blogspot.com/-4mwTYGoo99U/Tic141EFSgI/AAAAAAAAII0/Q2Y18D38iN0/s400/FalseSharing.png" width="358" /></a></div><div><br /></div><div>Which sounds fine. &nbsp;Until you realise that <code>tail</code> is being written to by your producer, and <code>head</code> is being written to by your consumer. &nbsp;These two variables aren&rsquo;t actually closely associated, and in fact are going to be used by two different threads that might be running on two different cores.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-ORwRPsgwzVI/Tic4MDC9SHI/AAAAAAAAII4/1bBv6awjOj0/s1600/FalseSharingWriteHead.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="375" src="http://4.bp.blogspot.com/-ORwRPsgwzVI/Tic4MDC9SHI/AAAAAAAAII4/1bBv6awjOj0/s400/FalseSharingWriteHead.png" width="400" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Imagine your consumer updates the value of <code>head</code>. &nbsp;The cache value is updated, the value in memory is updated, and any other cache lines that contain head are invalidated because other caches will not have the shiny new value. &nbsp;And remember that we deal with the level of the whole line, we can&rsquo;t just mark <code>head</code> as being invalid.</div><div style="text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-jPntzX3pGao/Tic6xdP9uXI/AAAAAAAAII8/THPUBZrvgX8/s1600/FalseSharingReadTail.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="385" src="http://4.bp.blogspot.com/-jPntzX3pGao/Tic6xdP9uXI/AAAAAAAAII8/THPUBZrvgX8/s400/FalseSharingReadTail.png" width="400" /></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Now if some process running on the other core just wants to read the value of <code>tail</code>, the whole cache line needs to be re-read from main memory. &nbsp;So a thread which is nothing to do with your consumer is reading a value which is nothing to do with <code>head</code>, and it&rsquo;s slowed down by a cache miss.</div><div><br /></div><div>Of course this is even worse if two separate threads are writing to the two different values.  Both cores are going to be invalidating the cache line on the other core and having to re-read it every time the other thread has written to it.  You&rsquo;ve basically got write-contention between the two threads even though they&rsquo;re writing to two different variables.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">This is called <a href="http://en.wikipedia.org/wiki/False_sharing">false sharing</a>, because every time you access <code>head</code> you get <code>tail</code> too, and every time you access <code>tail</code>, you get <code>head</code> as well. &nbsp;All this is happening under the covers, and no compiler warning is going to tell you that you just wrote code that&rsquo;s going to be very inefficient for concurrent access.</div><div style="text-align: left;"><br /></div><div style="text-align: left;"><b>Our solution - magic cache line padding</b></div><div style="text-align: left;">You&rsquo;ll see that the Disruptor eliminates this problem, at least for architecture that has a cache size of 64 bytes or less, by adding padding to ensure the ring buffer&rsquo;s sequence number is never in a cache line with anything else.</div><span class="Apple-style-span" style="-webkit-border-horizontal-spacing: 2px; -webkit-border-vertical-spacing: 2px; border-collapse: collapse; font-family: Monaco, 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Lucida Console', monospace; font-size: 12px; white-space: pre;"></span><br /><table id="src_table_0" style="border-collapse: collapse; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; text-align: left;"><tbody style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><tr id="sl_svn234_33" style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><td class="source" style="font-size: 12px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 4px; padding-right: 0px; padding-top: 0px; vertical-align: top; white-space: pre-wrap;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="kwd" style="color: #000088;">    public</span><span class="pln" style="color: black;"> </span><span class="kwd" style="color: #000088;">long</span><span class="pln" style="color: black;"> p1</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p2</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p3</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p4</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p5</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p6</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p7</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: black;"> </span><span class="com" style="color: #880000;">// cache line padding</span><span class="pln" style="color: black;"><br /></span></span></td></tr><tr id="sl_svn234_34" style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><td class="source" style="font-size: 12px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 4px; padding-right: 0px; padding-top: 0px; vertical-align: top; white-space: pre-wrap;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="pln" style="color: black;">&nbsp; &nbsp; </span><span class="kwd" style="color: #000088;">private</span><span class="pln" style="color: black;"> </span><span class="kwd" style="color: #000088;">volatile</span><span class="pln" style="color: black;"> </span><span class="kwd" style="color: #000088;">long</span><span class="pln" style="color: black;"> cursor </span><span class="pun" style="color: #666600;">=</span><span class="pln" style="color: black;"> INITIAL_CURSOR_VALUE</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: black;"><br /></span></span></td></tr><tr id="sl_svn234_35" style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><td class="source" style="font-size: 12px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0px; padding-left: 4px; padding-right: 0px; padding-top: 0px; vertical-align: top; white-space: pre-wrap;"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><span class="pln" style="color: black;">&nbsp; &nbsp; </span><span class="kwd" style="color: #000088;">public</span><span class="pln" style="color: black;"> </span><span class="kwd" style="color: #000088;">long</span><span class="pln" style="color: black;"> p8</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p9</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p10</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p11</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p12</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p13</span><span class="pun" style="color: #666600;">,</span><span class="pln" style="color: black;"> p14</span><span class="pun" style="color: #666600;">;</span><span class="pln" style="color: black;"> </span><span class="com" style="color: #880000;">// cache line padding</span></span></td></tr></tbody></table><div style="text-align: left;"><br /></div><div style="text-align: left;">So there&rsquo;s no false sharing, no unintended contention with any other variables, no needless cache misses.</div><div style="text-align: left;"><br /></div><div style="text-align: left;">It&rsquo;s worth doing this on your <code>Entry</code> classes too - if you have different consumers writing to different fields, you&rsquo;re going to need to make sure there&rsquo;s no false sharing between each of the fields.<br /><br /><br />EDIT: Martin wrote a more technically correct and detailed <a href="http://mechanical-sympathy.blogspot.com/2011/07/false-sharing.html">post about false sharing</a>, and posted performance results too.</div></p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/java" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">java</a>
   </li>
  
   <li class="list">
     <a href="/tags/disruptor" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">disruptor</a>
   </li>
  
   <li class="list">
     <a href="/tags/lmax" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">lmax</a>
   </li>
  
   <li class="list">
     <a href="/tags/mechanical-sympathy" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mechanical sympathy</a>
   </li>
  
   <li class="list">
     <a href="/tags/disruptor-docs" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">disruptor-docs</a>
   </li>
  
   <li class="list">
     <a href="/tags/concurrency" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">concurrency</a>
   </li>
  
</ul>
<div class="mt6">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    this.page.title = 'Dissecting the Disruptor: Why it\x27s so fast (part two) - Magic cache line padding';
    this.page.url = 'http:\/\/trishagee.github.io\/post\/dissecting_the_disruptor_why_its_so_fast_part_two__magic_cache_line_padding\/';
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "trishagee" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </main>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/post/dissecting_the_disruptor_why_its_so_fast_part_one__locks_are_bad/">Dissecting the Disruptor: Why it&#39;s so fast (part one) - Locks Are Bad</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/dissecting_the_disruptor_wiring_up_the_dependencies/">Dissecting the Disruptor: Wiring up the dependencies</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/dissecting_the_disruptor_writing_to_the_ring_buffer/">Dissecting the Disruptor: Writing to the ring buffer</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/dissecting_the_disruptor_how_do_i_read_from_the_ring_buffer/">Dissecting the Disruptor: How do I read from the ring buffer?</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/dissecting_the_disruptor_whats_so_special_about_a_ring_buffer/">Dissecting the Disruptor: What&#39;s so special about a ring buffer?</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/why_java_developers_hate_net/">Why Java developers hate .NET</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/gwt_why_verticalpanel_is_evil/">GWT: Why VerticalPanel is Evil</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/stac_london_summit/">STAC London Summit</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/getting_around_a_bit/">Getting around a bit</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/the_london_java_community_elected_to_the_jcp_seee_executive_committee/">The London Java Community elected to the JCP SE/EE Executive Committee</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/tradetech_2011__not_like_a_developer_conference/">TradeTech 2011 - Not like a developer conference</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/post/live_at_last/">Live at Last</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://trishagee.github.io" >
    &copy; 2019 Trisha Gee
  </a>
    <div>



  <a href="https://twitter.com/trisha_gee" class="link-transition twitter link dib z-999 pt3 pt0-l mr2" title="Twitter link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>



  <a href="https://www.youtube.com/user/pmgee/" class="link-transition youtube link dib z-999 pt3 pt0-l mr2" title="Youtube link">
    <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M42.527,41.34c-0.278,0-0.478,0.078-0.6,0.244  c-0.121,0.156-0.18,0.424-0.18,0.796v0.896h1.543V42.38c0-0.372-0.062-0.64-0.185-0.796C42.989,41.418,42.792,41.34,42.527,41.34z   M36.509,41.309c0.234,0,0.417,0.076,0.544,0.23c0.123,0.155,0.185,0.383,0.185,0.682v4.584c0,0.286-0.053,0.487-0.153,0.611  c-0.1,0.127-0.256,0.189-0.47,0.189c-0.148,0-0.287-0.033-0.421-0.096c-0.135-0.062-0.274-0.171-0.415-0.313v-5.531  c0.119-0.122,0.239-0.213,0.36-0.271C36.26,41.335,36.383,41.309,36.509,41.309z M41.748,44.658v1.672  c0,0.468,0.057,0.792,0.17,0.974c0.118,0.181,0.313,0.269,0.592,0.269c0.289,0,0.491-0.076,0.606-0.229  c0.114-0.153,0.175-0.489,0.175-1.013v-0.405h1.795v0.456c0,0.911-0.217,1.596-0.657,2.059c-0.435,0.459-1.089,0.687-1.958,0.687  c-0.781,0-1.398-0.242-1.847-0.731c-0.448-0.486-0.676-1.157-0.676-2.014v-3.986c0-0.768,0.249-1.398,0.742-1.882  c0.493-0.484,1.128-0.727,1.911-0.727c0.799,0,1.413,0.225,1.843,0.674c0.429,0.448,0.642,1.093,0.642,1.935v2.264H41.748z   M38.623,48.495c-0.271,0.336-0.669,0.501-1.187,0.501c-0.343,0-0.646-0.062-0.912-0.192c-0.267-0.129-0.519-0.327-0.746-0.601  v0.681h-1.764V36.852h1.764v3.875c0.237-0.27,0.485-0.478,0.748-0.616c0.267-0.143,0.534-0.212,0.805-0.212  c0.554,0,0.975,0.189,1.265,0.565c0.294,0.379,0.438,0.933,0.438,1.66v4.926C39.034,47.678,38.897,48.159,38.623,48.495z   M30.958,48.884v-0.976c-0.325,0.361-0.658,0.636-1.009,0.822c-0.349,0.191-0.686,0.282-1.014,0.282  c-0.405,0-0.705-0.129-0.913-0.396c-0.201-0.266-0.305-0.658-0.305-1.189v-7.422h1.744v6.809c0,0.211,0.037,0.362,0.107,0.457  c0.077,0.095,0.196,0.141,0.358,0.141c0.128,0,0.292-0.062,0.488-0.188c0.197-0.125,0.375-0.283,0.542-0.475v-6.744h1.744v8.878  H30.958z M24.916,38.6v10.284h-1.968V38.6h-2.034v-1.748h6.036V38.6H24.916z M32.994,32.978c0-0.001,12.08,0.018,13.514,1.45  c1.439,1.435,1.455,8.514,1.455,8.555c0,0-0.012,7.117-1.455,8.556C45.074,52.969,32.994,53,32.994,53s-12.079-0.031-13.516-1.462  c-1.438-1.435-1.441-8.502-1.441-8.556c0-0.041,0.004-7.12,1.441-8.555C20.916,32.996,32.994,32.977,32.994,32.978z M42.52,29.255  h-1.966v-1.08c-0.358,0.397-0.736,0.703-1.13,0.909c-0.392,0.208-0.771,0.312-1.14,0.312c-0.458,0-0.797-0.146-1.027-0.437  c-0.229-0.291-0.345-0.727-0.345-1.311v-8.172h1.962v7.497c0,0.231,0.045,0.399,0.127,0.502c0.08,0.104,0.216,0.156,0.399,0.156  c0.143,0,0.327-0.069,0.548-0.206c0.22-0.137,0.423-0.312,0.605-0.527v-7.422h1.966V29.255z M31.847,27.588  c0.139,0.147,0.339,0.219,0.6,0.219c0.266,0,0.476-0.075,0.634-0.223c0.157-0.152,0.235-0.358,0.235-0.618v-5.327  c0-0.214-0.08-0.387-0.241-0.519c-0.16-0.131-0.37-0.196-0.628-0.196c-0.241,0-0.435,0.065-0.586,0.196  c-0.148,0.132-0.225,0.305-0.225,0.519v5.327C31.636,27.233,31.708,27.439,31.847,27.588z M30.408,19.903  c0.528-0.449,1.241-0.674,2.132-0.674c0.812,0,1.48,0.237,2.001,0.711c0.517,0.473,0.777,1.083,0.777,1.828v5.051  c0,0.836-0.255,1.491-0.762,1.968c-0.513,0.476-1.212,0.714-2.106,0.714c-0.858,0-1.547-0.246-2.064-0.736  c-0.513-0.492-0.772-1.152-0.772-1.983v-5.068C29.613,20.954,29.877,20.351,30.408,19.903z M24.262,16h-2.229l2.634,8.003v5.252  h2.213v-5.5L29.454,16h-2.25l-1.366,5.298h-0.139L24.262,16z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30  S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

  </a>


  <a href="https://www.linkedin.com/in/trishagee/" class="link-transition linkedin link dib z-999 pt3 pt0-l mr2" title="LinkedIn link">
    <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

  </a>


  <a href="https://github.com/trishagee/" class="link-transition github link dib z-999 pt3 pt0-l mr2" title="Github link">
    <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

  </a>


</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
